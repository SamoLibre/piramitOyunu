<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Piramit - Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>
  <!-- GiriÅŸ EkranÄ± -->
  <div id="login-screen" class="login-screen">
    <div class="login-card">
      <div class="login-icon">ğŸ”º</div>
      <h1>Piramit Admin</h1>
      <p>Ä°statistikleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in yÃ¶netici anahtarÄ±nÄ± girin.</p>
      <form id="login-form">
        <input type="password" id="secret-input" placeholder="YÃ¶netici AnahtarÄ±" autocomplete="off" required>
        <button type="submit" class="login-btn">GiriÅŸ Yap</button>
      </form>
      <div class="login-error" id="login-error"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard hidden">
    <header class="dash-header">
      <div class="dash-header-left">
        <span class="dash-logo">ğŸ”º</span>
        <h1>Piramit Analytics</h1>
      </div>
      <div class="dash-header-right">
        <select id="period-select" class="period-select">
          <option value="7">Son 7 GÃ¼n</option>
          <option value="14">Son 14 GÃ¼n</option>
          <option value="30" selected>Son 30 GÃ¼n</option>
          <option value="60">Son 60 GÃ¼n</option>
          <option value="90">Son 90 GÃ¼n</option>
        </select>
        <button id="refresh-btn" class="refresh-btn" title="Yenile">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
            <path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
          </svg>
        </button>
        <button id="logout-btn" class="logout-btn" title="Ã‡Ä±kÄ±ÅŸ">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- YÃ¼kleniyor -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <span>Veriler yÃ¼kleniyor...</span>
    </div>

    <!-- Ä°Ã§erik -->
    <main id="content" class="content hidden">
      <!-- Ã–zet KartlarÄ± -->
      <section class="summary-cards">
        <div class="card card-primary">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </div>
          <div class="card-body">
            <span class="card-value" id="total-visitors">-</span>
            <span class="card-label">Toplam ZiyaretÃ§i</span>
          </div>
        </div>
        <div class="card card-blue">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <div class="card-body">
            <span class="card-value" id="today-visitors">-</span>
            <span class="card-label">BugÃ¼n ZiyaretÃ§i</span>
          </div>
        </div>
        <div class="card card-green">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
          </div>
          <div class="card-body">
            <span class="card-value" id="today-games">-</span>
            <span class="card-label">BugÃ¼n Oynanan</span>
          </div>
        </div>
        <div class="card card-gold">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="14" width="4" height="7" rx="1"/>
              <rect x="10" y="9" width="4" height="12" rx="1"/>
              <rect x="16" y="4" width="4" height="17" rx="1"/>
            </svg>
          </div>
          <div class="card-body">
            <span class="card-value" id="today-avg-score">-</span>
            <span class="card-label">BugÃ¼n Ort. Skor</span>
          </div>
        </div>
      </section>

      <!-- GÃ¼nlÃ¼k ZiyaretÃ§i GrafiÄŸi -->
      <section class="chart-section">
        <div class="section-header">
          <h2>GÃ¼nlÃ¼k ZiyaretÃ§iler</h2>
          <div class="chart-legend">
            <span class="legend-item"><span class="dot dot-blue"></span>ZiyaretÃ§i</span>
            <span class="legend-item"><span class="dot dot-green"></span>Oyun</span>
          </div>
        </div>
        <div class="chart-container" id="visitors-chart"></div>
      </section>

      <!-- GÃ¼nlÃ¼k Oyun Ä°statistikleri -->
      <section class="chart-section">
        <div class="section-header">
          <h2>Oyun DetaylarÄ±</h2>
        </div>
        <div class="stats-table-container">
          <table class="stats-table" id="daily-table">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>ZiyaretÃ§i</th>
                <th>Sayfa GÃ¶r.</th>
                <th>Oyun BaÅŸ.</th>
                <th>Oyun Bit.</th>
                <th>Ort. Skor</th>
                <th>Ä°pucu</th>
                <th>PaylaÅŸÄ±m</th>
              </tr>
            </thead>
            <tbody id="daily-table-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Son Etkinlikler -->
      <section class="chart-section">
        <div class="section-header">
          <h2>BugÃ¼nÃ¼n Etkinlikleri</h2>
          <span class="event-count" id="event-count">0 etkinlik</span>
        </div>
        <div class="events-list" id="events-list">
          <div class="no-events">HenÃ¼z etkinlik yok</div>
        </div>
      </section>
    </main>

    <!-- VeritabanÄ± BaÅŸlat -->
    <div id="db-init-section" class="db-init-section hidden">
      <div class="db-init-card">
        <h2>âš ï¸ VeritabanÄ± Kurulumu Gerekli</h2>
        <p>Tablolar henÃ¼z oluÅŸturulmamÄ±ÅŸ. Ä°lk kurulumda bu butona tÄ±klayÄ±n.</p>
        <button id="init-db-btn" class="login-btn" style="max-width: 300px; margin: 16px auto 0;">VeritabanÄ±nÄ± BaÅŸlat</button>
        <div id="init-db-msg" style="margin-top: 12px; font-size: 0.85rem;"></div>
      </div>
    </div>

    <!-- Son gÃ¼ncelleme -->
    <footer class="dash-footer" id="dash-footer"></footer>
  </div>

  <script>
    const STATS_ENDPOINT = '/api/stats';
    let analyticsSecret = '';

    // ========== GÄ°RÄ°Å ==========
    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const secretInput = document.getElementById('secret-input');
    const loginError = document.getElementById('login-error');

    // KayÄ±tlÄ± anahtarÄ± kontrol et
    const savedSecret = sessionStorage.getItem('piramit-admin-key');
    if (savedSecret) {
      analyticsSecret = savedSecret;
      loginScreen.classList.add('hidden');
      dashboard.classList.remove('hidden');
      loadDashboard();
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const key = secretInput.value.trim();
      if (!key) return;

      loginError.textContent = '';
      loginForm.querySelector('button').disabled = true;
      loginForm.querySelector('button').textContent = 'Kontrol ediliyor...';

      try {
        const res = await fetch(`${STATS_ENDPOINT}?days=1`, {
          headers: { 'X-Analytics-Secret': key }
        });

        if (res.ok) {
          analyticsSecret = key;
          sessionStorage.setItem('piramit-admin-key', key);
          loginScreen.classList.add('hidden');
          dashboard.classList.remove('hidden');
          loadDashboard();
        } else {
          loginError.textContent = 'GeÃ§ersiz anahtar. Tekrar deneyin.';
        }
      } catch (err) {
        loginError.textContent = 'BaÄŸlantÄ± hatasÄ±. Sunucu eriÅŸilebilir deÄŸil.';
      }

      loginForm.querySelector('button').disabled = false;
      loginForm.querySelector('button').textContent = 'GiriÅŸ Yap';
    });

    // Ã‡Ä±kÄ±ÅŸ
    document.getElementById('logout-btn').addEventListener('click', () => {
      sessionStorage.removeItem('piramit-admin-key');
      analyticsSecret = '';
      dashboard.classList.add('hidden');
      loginScreen.classList.remove('hidden');
      secretInput.value = '';
    });

    // ========== DASHBOARD ==========
    const periodSelect = document.getElementById('period-select');
    const refreshBtn = document.getElementById('refresh-btn');
    const loading = document.getElementById('loading');
    const content = document.getElementById('content');

    periodSelect.addEventListener('change', loadDashboard);
    refreshBtn.addEventListener('click', loadDashboard);

    async function loadDashboard() {
      loading.classList.remove('hidden');
      content.classList.add('hidden');

      const days = periodSelect.value;

      try {
        const res = await fetch(`${STATS_ENDPOINT}?days=${days}`, {
          headers: { 'X-Analytics-Secret': analyticsSecret }
        });

        if (!res.ok) {
          if (res.status === 401) {
            sessionStorage.removeItem('piramit-admin-key');
            dashboard.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginError.textContent = 'Oturum sÃ¼resi doldu. Tekrar giriÅŸ yapÄ±n.';
            return;
          }
          throw new Error('API hatasÄ±');
        }

        const data = await res.json();
        renderDashboard(data);
      } catch (err) {
        console.error('Dashboard load error:', err);
        // Tablo yoksa initÂ ekranÄ±nÄ± gÃ¶ster
        loading.classList.add('hidden');
        document.getElementById('db-init-section').classList.remove('hidden');
        setupDbInit();
        return;
      }

      document.getElementById('db-init-section').classList.add('hidden');
      loading.classList.add('hidden');
      content.classList.remove('hidden');
      document.getElementById('dash-footer').textContent =
        `Son gÃ¼ncelleme: ${new Date().toLocaleTimeString('tr-TR')}`;
    }

    function renderDashboard(data) {
      const { totalVisitors, dailyStats, recentEvents } = data;
      const today = dailyStats[0] || {};

      // Ã–zet kartlarÄ±
      document.getElementById('total-visitors').textContent = formatNumber(totalVisitors);
      document.getElementById('today-visitors').textContent = formatNumber(today.uniqueVisitors || 0);
      document.getElementById('today-games').textContent = formatNumber(today.gamesCompleted || 0);
      document.getElementById('today-avg-score').textContent = today.avgScore || 0;

      // Grafik
      renderChart(dailyStats);

      // Tablo
      renderTable(dailyStats);

      // Etkinlikler
      renderEvents(recentEvents);
    }

    // ========== GRAFÄ°K ==========
    function renderChart(stats) {
      const container = document.getElementById('visitors-chart');
      container.innerHTML = '';

      // Verileri tersine Ã§evir (eskiden yeniye)
      const data = [...stats].reverse();

      if (data.length === 0) {
        container.innerHTML = '<div class="no-events">Veri bulunamadÄ±</div>';
        return;
      }

      const maxVisitors = Math.max(...data.map(d => d.uniqueVisitors), 1);
      const maxGames = Math.max(...data.map(d => d.gamesCompleted), 1);
      const maxVal = Math.max(maxVisitors, maxGames, 1);

      data.forEach(day => {
        const col = document.createElement('div');
        col.className = 'chart-col';

        const barsWrap = document.createElement('div');
        barsWrap.className = 'chart-bars';

        // ZiyaretÃ§i Ã§ubuÄŸu
        const vBar = document.createElement('div');
        vBar.className = 'chart-bar bar-blue';
        const vHeight = Math.max((day.uniqueVisitors / maxVal) * 100, 2);
        vBar.style.height = vHeight + '%';
        vBar.title = `${day.uniqueVisitors} ziyaretÃ§i`;

        const vLabel = document.createElement('span');
        vLabel.className = 'bar-value';
        vLabel.textContent = day.uniqueVisitors || '';
        vBar.appendChild(vLabel);

        // Oyun Ã§ubuÄŸu
        const gBar = document.createElement('div');
        gBar.className = 'chart-bar bar-green';
        const gHeight = Math.max((day.gamesCompleted / maxVal) * 100, 2);
        gBar.style.height = gHeight + '%';
        gBar.title = `${day.gamesCompleted} oyun`;

        const gLabel = document.createElement('span');
        gLabel.className = 'bar-value';
        gLabel.textContent = day.gamesCompleted || '';
        gBar.appendChild(gLabel);

        barsWrap.appendChild(vBar);
        barsWrap.appendChild(gBar);

        // Tarih etiketi
        const dateLabel = document.createElement('span');
        dateLabel.className = 'chart-date';
        const d = new Date(day.date + 'T00:00:00');
        dateLabel.textContent = `${d.getDate()}/${d.getMonth() + 1}`;

        col.appendChild(barsWrap);
        col.appendChild(dateLabel);
        container.appendChild(col);
      });
    }

    // ========== TABLO ==========
    function renderTable(stats) {
      const tbody = document.getElementById('daily-table-body');
      tbody.innerHTML = '';

      stats.forEach(day => {
        const tr = document.createElement('tr');
        const d = new Date(day.date + 'T00:00:00');
        const dateStr = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', weekday: 'short' });

        tr.innerHTML = `
          <td class="td-date">${dateStr}</td>
          <td>${day.uniqueVisitors}</td>
          <td>${day.pageViews}</td>
          <td>${day.gamesStarted}</td>
          <td>${day.gamesCompleted}</td>
          <td class="td-score">${day.avgScore}<span class="score-range">${day.maxScore ? ` (${day.minScore}-${day.maxScore})` : ''}</span></td>
          <td>${day.hintsUsed}</td>
          <td>${day.shares}</td>
        `;
        tbody.appendChild(tr);
      });

      if (stats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">Veri bulunamadÄ±</td></tr>';
      }
    }

    // ========== ETKÄ°NLÄ°KLER ==========
    const EVENT_LABELS = {
      page_view: { label: 'Sayfa GÃ¶rÃ¼ntÃ¼leme', icon: 'ğŸ‘ï¸', color: '#5DADE2' },
      game_start: { label: 'Oyun BaÅŸlatÄ±ldÄ±', icon: 'ğŸ®', color: '#58D68D' },
      game_complete: { label: 'Oyun TamamlandÄ±', icon: 'ğŸ†', color: '#F4D03F' },
      game_over: { label: 'Oyun Bitti (Can)', icon: 'ğŸ’€', color: '#E74C3C' },
      hint_used: { label: 'Ä°pucu KullanÄ±ldÄ±', icon: 'ğŸ’¡', color: '#AF7AC5' },
      row_complete: { label: 'SatÄ±r TamamlandÄ±', icon: 'âœ…', color: '#27AE60' },
      share: { label: 'PaylaÅŸÄ±m', icon: 'ğŸ“¤', color: '#3498DB' },
      session_end: { label: 'Oturum Sonu', icon: 'ğŸ‘‹', color: '#95A5A6' },
      endless_start: { label: 'Sonsuz Mod BaÅŸlatÄ±ldÄ±', icon: 'â™¾ï¸', color: '#E67E22' }
    };

    function renderEvents(events) {
      const list = document.getElementById('events-list');
      const countEl = document.getElementById('event-count');
      countEl.textContent = `${events.length} etkinlik`;

      if (!events || events.length === 0) {
        list.innerHTML = '<div class="no-events">BugÃ¼n henÃ¼z etkinlik kaydedilmedi</div>';
        return;
      }

      list.innerHTML = '';
      events.forEach(evt => {
        const info = EVENT_LABELS[evt.event] || { label: evt.event, icon: 'ğŸ“Œ', color: '#BDC3C7' };
        const time = evt.serverTime
          ? new Date(evt.serverTime).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })
          : '??:??';

        const item = document.createElement('div');
        item.className = 'event-item';

        let detail = '';
        if (evt.event === 'game_complete' && evt.score !== undefined) {
          detail = `Skor: ${evt.score}/150`;
        } else if (evt.event === 'game_start' && evt.mode) {
          detail = `Mod: ${evt.mode}`;
        } else if (evt.event === 'share' && evt.platform) {
          detail = `Platform: ${evt.platform}`;
        } else if (evt.event === 'session_end' && evt.totalDuration) {
          detail = `SÃ¼re: ${formatDuration(evt.totalDuration)}`;
        } else if (evt.event === 'row_complete' && evt.rowIndex !== undefined) {
          detail = `SatÄ±r: ${evt.rowIndex + 1}, Skor: ${evt.rowScore || 0}`;
        }

        const location = (evt.city && evt.city !== 'unknown')
          ? `${evt.city}, ${evt.country}`
          : (evt.country && evt.country !== 'unknown' ? evt.country : '');

        item.innerHTML = `
          <span class="event-icon" style="color: ${info.color}">${info.icon}</span>
          <div class="event-info">
            <span class="event-name">${info.label}</span>
            ${detail ? `<span class="event-detail">${detail}</span>` : ''}
            ${location ? `<span class="event-location">ğŸ“ ${location}</span>` : ''}
          </div>
          <div class="event-meta">
            <span class="event-time">${time}</span>
            <span class="event-visitor" title="${evt.visitorId || ''}">${(evt.visitorId || '').slice(0, 8)}</span>
          </div>
        `;

        list.appendChild(item);
      });
    }

    // ========== YARDIMCILAR ==========
    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }

    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds}sn`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}dk ${seconds % 60}sn`;
      return `${Math.floor(seconds / 3600)}sa ${Math.floor((seconds % 3600) / 60)}dk`;
    }

    // DB BaÅŸlat
    let dbInitSetup = false;
    function setupDbInit() {
      if (dbInitSetup) return;
      dbInitSetup = true;
      const btn = document.getElementById('init-db-btn');
      const msg = document.getElementById('init-db-msg');
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        btn.textContent = 'OluÅŸturuluyor...';
        msg.textContent = '';
        msg.style.color = '';
        try {
          const res = await fetch('/api/init-db', {
            headers: { 'X-Analytics-Secret': analyticsSecret }
          });
          const data = await res.json();
          if (res.ok) {
            msg.style.color = '#22C55E';
            msg.textContent = 'âœ… ' + (data.message || 'BaÅŸarÄ±lÄ±!');
            setTimeout(() => loadDashboard(), 1500);
          } else {
            msg.style.color = '#EF4444';
            msg.textContent = 'âŒ ' + (data.error || 'Hata oluÅŸtu');
          }
        } catch (e) {
          msg.style.color = '#EF4444';
          msg.textContent = 'âŒ BaÄŸlantÄ± hatasÄ±';
        }
        btn.disabled = false;
        btn.textContent = 'VeritabanÄ±nÄ± BaÅŸlat';
      });
    }

    // Otomatik yenileme (her 60 saniye)
    setInterval(() => {
      if (!dashboard.classList.contains('hidden')) {
        loadDashboard();
      }
    }, 60000);
  </script>
</body>
</html>
